<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Emacs Syntax Highlight</title>
    <link rel="stylesheet" href="index.css" />
  </head>
  <body>
    <div id="main">
      <h1>Emacs Syntax Highlight</h1>
      <form>
        <p>
          <label for="mode">Major mode: </label>
          <input list="mode-list" id="mode" type="text" value="emacs-lisp-mode" required />
          <datalist id="mode-list">
            <option value="ada-mode">
            <option value="antlr-mode">
            <option value="archive-mode">
            <option value="asm-mode">
            <option value="authinfo-mode">
            <option value="autoconf-mode">
            <option value="awk-mode">
            <option value="bat-mode">
            <option value="bibtex-mode">
            <option value="bibtex-style-mode">
            <option value="bovine-grammar-mode">
            <option value="c++-mode">
            <option value="c-mode">
            <option value="c-or-c++-mode">
            <option value="change-log-mode">
            <option value="compilation-mode">
            <option value="conf-colon-mode">
            <option value="conf-desktop-mode">
            <option value="conf-javaprop-mode">
            <option value="conf-mode">
            <option value="conf-ppd-mode">
            <option value="conf-space-mode">
            <option value="conf-toml-mode">
            <option value="conf-unix-mode">
            <option value="conf-windows-mode">
            <option value="conf-xdefaults-mode">
            <option value="css-mode">
            <option value="dcl-mode">
            <option value="delphi-mode">
            <option value="diff-mode">
            <option value="dns-mode">
            <option value="doctex-mode">
            <option value="dsssl-mode">
            <option value="ebrowse-tree-mode">
            <option value="elisp-byte-code-mode">
            <option value="emacs-lisp-mode">
            <option value="f90-mode">
            <option value="fortran-mode">
            <option value="fundamental-mode">
            <option value="gdb-script-mode">
            <option value="icon-mode">
            <option value="idl-mode">
            <option value="idlwave-mode">
            <option value="image-mode">
            <option value="java-mode">
            <option value="javascript-mode">
            <option value="latex-mode">
            <option value="ld-script-mode">
            <option value="less-css-mode">
            <option value="lisp-mode">
            <option value="m2-mode">
            <option value="m4-mode">
            <option value="mail-mode">
            <option value="makefile-automake-mode">
            <option value="makefile-bsdmake-mode">
            <option value="makefile-gmake-mode">
            <option value="makefile-imake-mode">
            <option value="makefile-makepp-mode">
            <option value="metafont-mode">
            <option value="metapost-mode">
            <option value="mhtml-mode">
            <option value="mixal-mode">
            <option value="nroff-mode">
            <option value="objc-mode">
            <option value="octave-maybe-mode">
            <option value="org-mode">
            <option value="pascal-mode">
            <option value="perl-mode">
            <option value="pike-mode">
            <option value="prolog-mode">
            <option value="ps-mode">
            <option value="python-mode">
            <option value="rst-mode">
            <option value="ruby-mode">
            <option value="scheme-mode">
            <option value="scribe-mode">
            <option value="scss-mode">
            <option value="ses-mode">
            <option value="sgml-mode">
            <option value="sh-mode">
            <option value="shell-script-mode">
            <option value="sieve-mode">
            <option value="simula-mode">
            <option value="snmp-mode">
            <option value="snmpv2-mode">
            <option value="sql-mode">
            <option value="srecode-template-mode">
            <option value="tar-mode">
            <option value="tcl-mode">
            <option value="tex-mode">
            <option value="texinfo-mode">
            <option value="text-mode">
            <option value="vera-mode">
            <option value="verilog-mode">
            <option value="vhdl-mode">
            <option value="wisent-grammar-mode">
            <option value="xml-mode">
          </datalist>
        </p>
        <p>
          <label for="theme">Theme: </label>
          <select id="theme">
            <option value="default">default</option>
            <option value="adwaita">adwaita</option>
            <option value="deeper-blue">deeper-blue</option>
            <option value="dichromacy">dichromacy</option>
            <option value="leuven">leuven</option>
            <option value="light-blue">light-blue</option>
            <option value="manoj-dark">manoj-dark</option>
            <option value="misterioso">misterioso</option>
            <option value="tango-dark">tango-dark</option>
            <option value="tango">tango</option>
            <option value="tsdh-dark">tsdh-dark</option>
            <option value="tsdh-light">tsdh-light</option>
            <option value="wheatgrass">wheatgrass</option>
            <option value="whiteboard">whiteboard</option>
            <option value="wombat">wombat</option>
          </select>
        </p>
        <p>
          <span>Background mode: </span>
          <input
            type="radio"
            id="light"
            name="backgroundMode"
            value=""
            checked
          />
          <label for="id">light (default)</label>
          <input type="radio" id="dark" name="backgroundMode" value="dark" />
          <label for="id">dark</label>
        </p>
        <p>
          <label for="code">Code: </label>
          <textarea id="code" rows="12" required>
(defmacro with-temp-buffer (&rest body)
  "Create a temporary buffer, and evaluate BODY there like `progn'.
See also `with-temp-file' and `with-output-to-string'."
  (declare (indent 0) (debug t))
  (let ((temp-buffer (make-symbol "temp-buffer")))
    `(let ((,temp-buffer (generate-new-buffer " *temp*")))
       ;; `kill-buffer' can change current-buffer in some odd cases.
       (with-current-buffer ,temp-buffer
         (unwind-protect
	     (progn ,@body)
           (and (buffer-name ,temp-buffer)
                (kill-buffer ,temp-buffer)))))))</textarea
          >
        </p>
        <p>
          <input type="submit" value="Highlight" />
        </p>
        <p>
          <output id="result" for="mode theme code"></output>
        </p>
      </form>
      <footer>
        <p>
          The syntax highlighting is powered by GNU Emacs using
          <a href="https://github.com/Lindydancer/e2ansi">e2ansi</a> and
          <a href="https://www.npmjs.com/package/ansi-to-html">ansi-to-html</a>.
        </p>
        <p>
          View source on
          <a
            href="https://github.com/xuchunyang/emacs-syntax-highlighting-as-a-service"
            >GitHub</a
          >
        </p>
      </footer>
    </div>
    <script>
      const form = document.querySelector("form");
      let saveState = () => {};
      let loadState = () => {};
      try {
        localStorage;
        let saveState = (state) => {
          console.log("saveState");
          localStorage.setItem("state", JSON.stringify(state));
        };
        let loadState = () => {
          let state = localStorage.getItem("state");
          if (state) {
            console.log("loadState");
            state = JSON.parse(state);
            form.mode.value = state.mode;
            form.theme.value = state.theme;
            form.backgroundMode.value = state.backgroundMode;
            form.code.value = state.code;
            form.result.innerHTML = state.result;
          }
        };
      } catch (e) {
        console.log("localStorage is not available", e);
      }
      loadState();
      form.onsubmit = (e) => {
        e.preventDefault();
        form.result.value = "Sending your code to server to highlight...";
        const mode = form.mode.value;
        const code = form.code.value;
        const theme = form.theme.value;
        const backgroundMode = form.backgroundMode.value;
        fetch("/api/highlight", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ mode, code, theme, backgroundMode }),
        })
          .then((response) => response.json())
          .then((json) => {
            console.log("JSON:", json);
            // error case 1, missing args
            if (json.error) {
              form.result.value = json.error;
              return;
            }
            // error case 2, from exec
            const { error, stderr, stdout } = json.data;
            if (error || stderr) {
              form.result.value = "Error: " + (error || stderr);
              return;
            }
            // finally show the result
            form.result.innerHTML = `<pre>${json.data.stdout}</pre>`;

            saveState({
              mode,
              code,
              theme,
              backgroundMode,
              result: form.result.innerHTML,
            });
          })
          .catch((error) => {
            console.error(error);
            form.result.value = "Error: " + error.message;
          });
      };
    </script>
  </body>
</html>
